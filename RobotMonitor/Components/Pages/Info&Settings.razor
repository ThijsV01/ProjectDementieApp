@page "/info&settings"
@using SimpleMqtt
@using System.Text.Json
@inject ISqlBatteryRepository SqlBatteryRepository
@inject ISqlSensorRepository SqlSensorRepository
@inject ISqlRobotRepository SqlRobotRepository
@inject SimpleMqttClient mqttClient
@rendermode InteractiveServer

<PageTitle>Info & Settings</PageTitle>

<div class="container-fluid mt-4">

    <div class="row g-4">
        <!-- ============================
             1. SETTINGS
        ============================= -->
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <strong>Settings</strong>
                </div>
                <div class="card-body">
                    @if (robots == null)
                    {
                        <p><em>Loading...</em></p>
                    }
                    else if (robots.Count == 0)
                    {
                        <p>No commands found.</p>
                    }
                    else
                    {
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Id</th>
                                    <th>Name</th>
                                    <th>Model</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (Robot robot in robots)
                                {
                                    <tr>
                                        <td>@robot.robotID</td>
                                        @if (robot.robotID == 1)
                                        {
                                            <td>
                                                <input type="text" class="form-control form-control-sm" @bind="robot.Naam" />
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm" @bind="robot.Model" />
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-success"
                                                    @onclick="() => UpdateRobot(robot)">Update</button>
                                            </td>
                                        }
                                        else
                                        {
                                            <td>@robot.Naam</td>
                                            <td>@robot.Model</td>
                                            <td></td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>
        <!-- ============================
             2. INFORMATION
        ============================= -->
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <strong>Information</strong>
                </div>
                <div class="card-body">
                    <p>Last registered sensordata:
                        @if (PIRMotionState == null || PIRMotionState.Count == 0)
                        {
                            <span>No sensor data available</span>
                        }
                        else
                        {
                            <span>
                                @PIRMotionState[0].Datum.ToString("yyyy-MM-dd")
                                @PIRMotionState[0].Tijdstip.ToString(@"hh\:mm\:ss")
                            </span>
                        }
                    </p>
                </div>
            </div>
        </div>
        <!-- ============================
             3. BATTERYSTATE
        ============================= -->
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-success text-white">
                    <strong>Batterystate</strong>
                </div>
                <div class="card-body">
                    <i class="@BatteryIcon fa-3x" style="@BatteryColor font-size: 3rem;">@batteryStatus%</i>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private int batteryStatus;
    private List<SensorMeting>? PIRMotionState;
    private List<Robot>? robots;
    protected override async Task OnInitializedAsync()
    {
        batteryStatus = await SqlBatteryRepository.GetBatteryStatusInMillivoltsAsync(1);
        PIRMotionState = await SqlSensorRepository.SelectSensorDataPIRMotion(1);
        robots = await SqlRobotRepository.SelectAllRobots();

        mqttClient.OnMessageReceived += async (sender, args) =>
        {
            Console.WriteLine($"Topic: {args.Topic} Message: {args.Message}");

            if (args.Topic!.StartsWith("robot/2242722/battery"))
            {
                await Task.Delay(50);
                batteryStatus = await SqlBatteryRepository.GetBatteryStatusInMillivoltsAsync(1);
                await InvokeAsync(StateHasChanged);
            }
            if (args.Topic!.StartsWith("robot/2242722/sensor/"))
            {
                await Task.Delay(50);
                PIRMotionState = await SqlSensorRepository.SelectSensorDataPIRMotion(1);
                await InvokeAsync(StateHasChanged);
            }
        };
    }
    private async Task UpdateRobot(Robot robot)
    {
        if (robot.Naam != "" || robot.Model != "")
        {
            string payload = JsonSerializer.Serialize(robot);
            await mqttClient.PublishMessage(payload, "robot/2242722/robot/edit");
        }
        robots = await SqlRobotRepository.SelectAllRobots();
        await InvokeAsync(StateHasChanged);
    }
    private string BatteryColor =>
    batteryStatus < 25 ? "color:red" :
    "color:rgb(70, 70, 70)";

    private string BatteryIcon =>
    batteryStatus < 20 ? "fas fa-battery-empty" :
    batteryStatus < 40 ? "fas fa-battery-quarter" :
    batteryStatus < 60 ? "fas fa-battery-half" :
    batteryStatus < 80 ? "fas fa-battery-three-quarters" :
    "fas fa-battery-full";
}