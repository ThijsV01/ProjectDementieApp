@page "/info&settings"
@using SimpleMqtt
@inject ISqlBatteryRepository SqlBatteryRepository
@inject ISqlSensorRepository SqlSensorRepository
@inject SimpleMqttClient mqttClient
@rendermode InteractiveServer

<PageTitle>Info & Settings</PageTitle>

<div class="container-fluid mt-4">

    <div class="row g-4">
        <!-- ============================
             1. SETTINGS
        ============================= -->
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <strong>Settings</strong>
                </div>
                <div class="card-body">
                    <!-- Voeg hier jouw instellingen toe -->
                </div>
            </div>
        </div>
        <!-- ============================
             2. INFORMATION
        ============================= -->
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <strong>Information</strong>
                </div>
                <div class="card-body">
                    <p>Last registered sensordata:
                        @if (PIRMotionState == null || PIRMotionState.Count == 0)
                        {
                            <span>No sensor data available</span>
                        }
                        else
                        {
                            <span>
                                @PIRMotionState[0].Datum.ToString("yyyy-MM-dd")
                                @PIRMotionState[0].Tijdstip.ToString(@"hh\:mm\:ss")
                            </span>
                        }
                    </p>
                </div>
            </div>
        </div>
        <!-- ============================
             3. BATTERYSTATE
        ============================= -->
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-success text-white">
                    <strong>Batterystate</strong>
                </div>
                <div class="card-body">
                    <i class="@BatteryIcon fa-3x" style="@BatteryColor font-size: 3rem;">@batteryStatus%</i>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private int batteryStatus;
    private List<SensorMeting>? PIRMotionState;
    protected override async Task OnInitializedAsync()
    {
        batteryStatus = await SqlBatteryRepository.GetBatteryStatusInMillivoltsAsync(1);
        PIRMotionState = await SqlSensorRepository.SelectSensorDataPIRMotion(1);

        mqttClient.OnMessageReceived += async (sender, args) =>
        {
            Console.WriteLine($"Topic: {args.Topic} Message: {args.Message}");

            if (args.Topic!.StartsWith("robot/2242722/battery"))
            {
                await Task.Delay(50);
                batteryStatus = await SqlBatteryRepository.GetBatteryStatusInMillivoltsAsync(1);
                await InvokeAsync(StateHasChanged);
            }
            if (args.Topic!.StartsWith("robot/2242722/sensor/"))
            {
                await Task.Delay(50);
                PIRMotionState = await SqlSensorRepository.SelectSensorDataPIRMotion(1);
                await InvokeAsync(StateHasChanged);
            }
        };
    }
    private string BatteryColor =>
    batteryStatus < 25 ? "color:red" :
    "color:rgb(70, 70, 70)";

    private string BatteryIcon =>
    batteryStatus < 20 ? "fas fa-battery-empty" :
    batteryStatus < 40 ? "fas fa-battery-quarter" :
    batteryStatus < 60 ? "fas fa-battery-half" :
    batteryStatus < 80 ? "fas fa-battery-three-quarters" :
    "fas fa-battery-full";
}