@page "/interactions"
@inject ISqlInteractionMomentsRepository SqlInteractionMomentsRepository
@using SimpleMqtt
@inject SimpleMqttClient mqttClient
@rendermode InteractiveServer
<PageTitle>Interactions</PageTitle>

@if (interactionMoments == null)
{
    <p><em>Loading...</em></p>
}
else if (interactionMoments.Count == 0)
{
    <p>No commands found.</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Interaction Moments</th>
            </tr>
        </thead>
        <tbody>
            @foreach (InteractieMoment interactionMoment in interactionMoments)
            {
                <tr>
                    <td>@interactionMoment.Tijdstip.ToString(@"hh\:mm\:ss")</td>
                    <td>
                        <button class="btn btn-sm btn-danger"
                            @onclick="() => DeleteInteraction(interactionMoment.InteractieID)">
                            Delete
                        </button>
                    </td>
                </tr>
            }
            <tr>

                <td colspan="2">
                    <input type="time" @bind="newTime" class="form-control" />
                    <button class="btn btn-sm btn-primary mt-1"
                        @onclick="() => AddInteractionWithTime(interactionMoments[0].RobotID)">
                        Add
                    </button>
                </td>
            </tr>
        </tbody>
    </table>
}
@code {
    private List<InteractieMoment>? interactionMoments;
    protected override async Task OnInitializedAsync()
    {
        interactionMoments = await SqlInteractionMomentsRepository.SelectInteractionMoments();
    }

    private async Task DeleteInteraction(int id)
    {
        await mqttClient.PublishMessage($"{id}", "robot/2242722/interactionmoment/delete");
        // Refresh list
        interactionMoments = await SqlInteractionMomentsRepository.SelectInteractionMoments();
    }
    private TimeOnly? newTime;

    private async Task AddInteractionWithTime(int robotID)
    {
        if (!newTime.HasValue)
        {
            return;
        }
        string payload = $"{robotID};{newTime.Value:HH:mm:ss}";
        await mqttClient.PublishMessage(payload, $"robot/2242722/interactionmoment/add");
        newTime = null;
        // Refresh list
        interactionMoments = await SqlInteractionMomentsRepository.SelectInteractionMoments();
    }
}