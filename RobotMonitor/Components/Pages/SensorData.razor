@page "/sensordata"
@using SimpleMqtt
@inject ISqlSensorRepository SqlSensorRepository
@inject SimpleMqttClient mqttClient
@rendermode InteractiveServer

<PageTitle>Sensor Data</PageTitle>

<div class="py-3">

    <div class="card mb-3">
        <div class="card-header text-white bg-primary">
            <strong>Obstacle Distances</strong>
        </div>
        <div class="card-body p-0 table-wrapper">
            @if (ObstacleDistances == null)
            {
                <p class="text-center my-3"><em>Loading...</em></p>
            }
            else if (ObstacleDistances.Count == 0)
            {
                <p class="text-center my-3">No sensor data found.</p>
            }
            else
            {
                <table class="table table-striped table-hover mb-0 fixed-table">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th style="width: 33%;">Date</th>
                            <th style="width: 33%;">Time</th>
                            <th style="width: 34%;">Obstacle Distance</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var meting in ObstacleDistances)
                        {
                            <tr class="sensor-row">
                                <td>@meting.Datum.ToString("dd-MM-yyyy")</td>
                                <td>@meting.Tijdstip.ToString(@"hh\:mm\:ss")</td>
                                <td>@meting.Waarde cm</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header text-white bg-primary">
            <strong>PIR Motion Detection</strong>
        </div>
        <div class="card-body p-0 table-wrapper">
            @if (PIRMotionState == null)
            {
                <p class="text-center my-3"><em>Loading...</em></p>
            }
            else if (PIRMotionState.Count == 0)
            {
                <p class="text-center my-3">No sensor data found.</p>
            }
            else
            {
                <table class="table table-striped table-hover mb-0 fixed-table">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th style="width: 33%;">Date</th>
                            <th style="width: 33%;">Time</th>
                            <th style="width: 34%;">Detection State</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var meting in PIRMotionState)
                        {
                            <tr class="sensor-row">
                                <td>@meting.Datum.ToString("dd-MM-yyyy")</td>
                                <td>@meting.Tijdstip.ToString(@"hh\:mm\:ss")</td>
                                <td>
                                    @if (meting.Waarde == 0)
                                    {
                                        <span>No human detected</span>
                                    }
                                    else if (meting.Waarde == 1)
                                    {
                                        <span>Human detected</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>

</div>

@code {
    private List<SensorMeting>? ObstacleDistances;
    private List<SensorMeting>? PIRMotionState;

    protected override async Task OnInitializedAsync()
    {
        ObstacleDistances = await SqlSensorRepository.SelectSensorDataObstacleDistance(1);
        PIRMotionState = await SqlSensorRepository.SelectSensorDataPIRMotion(1);

        mqttClient.OnMessageReceived += async (sender, args) =>
        {
            if (args.Topic!.StartsWith("robot/2242722/sensor/"))
            {
                await Task.Delay(50);
                ObstacleDistances = await SqlSensorRepository.SelectSensorDataObstacleDistance(1);
                PIRMotionState = await SqlSensorRepository.SelectSensorDataPIRMotion(1);
                await InvokeAsync(StateHasChanged);
            }
        };
    }
}